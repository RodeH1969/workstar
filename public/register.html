<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WorkStar Daily Registration - Office Competition Entry</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1E3A8A 0%, #3B82F6 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-width: 500px;
            width: 100%;
            text-align: center;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2rem;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1rem;
        }
        
        .status {
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffeaa7;
        }
        
        .loading {
            background: #d1ecf1;
            color: #0c5460;
            border: 2px solid #bee5eb;
        }
        
        .form-section {
            margin: 30px 0;
        }
        
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }
        
        input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus {
            outline: none;
            border-color: #FFD700;
        }
        
        .register-btn {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #1E3A8A;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            width: 100%;
            transition: transform 0.2s;
        }
        
        .register-btn:hover {
            transform: translateY(-2px);
        }
        
        .register-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .info-box {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #FFD700;
        }
        
        .countdown {
            font-size: 2rem;
            color: #FFD700;
            font-weight: bold;
            margin: 20px 0;
        }
        
        .already-registered {
            background: #e7f3ff;
            border: 2px solid #007bff;
            color: #0056b3;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
        }
        
        .prize-info {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #333;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            border: 2px solid #ffc107;
        }
        
        .steps {
            text-align: left;
            margin: 20px 0;
        }
        
        .step {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }
        
        .business-info {
            background: #e9ecef;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <img src="workstar_logo.png" alt="WorkStar Logo" style="height: 100px; margin-bottom: 20px;">
        <h1>WorkStar Daily Competition</h1>
        <div class="subtitle">Register for today's prize competition</div>
        
        <div id="accessStatus"></div>
        <div id="registrationForm" style="display: none;"></div>
        <div id="alreadyRegistered" style="display: none;"></div>
    </div>

    <script>
        // Configuration - will be set from QR parameters
        let TARGET_OFFICE = null;
        let currentBusiness = "";
        let businessId = "";
        let hasValidAccess = false;
        
        // Utility functions
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Earth's radius in meters
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        function getTodayKey() {
            return new Date().toISOString().split('T')[0]; // YYYY-MM-DD format
        }
        
        function hasRegisteredToday(phone) {
            const today = getTodayKey();
            const registrations = JSON.parse(localStorage.getItem('dailyRegistrations') || '{}');
            return registrations[today] && registrations[today].includes(phone);
        }
        
        function registerForToday(employee) {
            const today = getTodayKey();
            const registrations = JSON.parse(localStorage.getItem('dailyRegistrations') || '{}');
            
            if (!registrations[today]) {
                registrations[today] = [];
            }
            
            registrations[today].push(employee.phone);
            localStorage.setItem('dailyRegistrations', JSON.stringify(registrations));
            
            // Store employee details
            const employees = JSON.parse(localStorage.getItem('employees') || '{}');
            employees[employee.phone] = employee;
            localStorage.setItem('employees', JSON.stringify(employees));
        }
        
        function checkQRAccess() {
            const urlParams = new URLSearchParams(window.location.search);
            businessId = urlParams.get('biz');
            const lat = urlParams.get('lat');
            const lng = urlParams.get('lng');
            const businessName = urlParams.get('name');
            const qrTimestamp = urlParams.get('t');
            
            console.log('QR Parameters:', { businessId, lat, lng, businessName, qrTimestamp });
            
            if (!businessId || !lat || !lng || !businessName || !qrTimestamp) {
                showAccessDenied("Invalid access. This page can only be accessed by scanning an official WorkStar QR code from your office.");
                return false;
            }
            
            // Validate coordinates
            const latitude = parseFloat(lat);
            const longitude = parseFloat(lng);
            
            if (isNaN(latitude) || isNaN(longitude) || 
                latitude < -90 || latitude > 90 || longitude < -180 || longitude > 180) {
                showAccessDenied("Invalid QR code data. Please contact WorkStar support.");
                return false;
            }
            
            // Check if QR code is recent (within 10 minutes)
            const qrTime = parseInt(qrTimestamp);
            const currentTime = Date.now();
            const timeDiff = currentTime - qrTime;
            
            if (timeDiff > 10 * 60 * 1000) { // 10 minutes in milliseconds
                showAccessDenied("QR code has expired. Please scan a fresh QR code from your office.");
                return false;
            }
            
            // Set the target office from QR parameters
            TARGET_OFFICE = {
                lat: latitude,
                lng: longitude,
                name: decodeURIComponent(businessName),
                radius: 50 // 50 meter security radius
            };
            
            currentBusiness = decodeURIComponent(businessName);
            
            console.log('Target Office Set:', TARGET_OFFICE);
            
            return true;
        }
        
        function verifyLocation() {
            document.getElementById('accessStatus').innerHTML = `
                <div class="business-info">
                    <strong>üè¢ ${currentBusiness}</strong><br>
                    <small>Business ID: ${businessId}</small>
                </div>
                <div class="status loading">
                    üìç Verifying your location...<br>
                    <small>Please allow location access when prompted</small><br>
                    <small>You must be within 50 meters of your office address</small>
                </div>
            `;
            
            if (!navigator.geolocation) {
                showAccessDenied("Geolocation is not supported by this device. Registration requires location verification for security.");
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const userLat = position.coords.latitude;
                    const userLng = position.coords.longitude;
                    const accuracy = position.coords.accuracy;
                    
                    const distance = calculateDistance(
                        userLat, userLng,
                        TARGET_OFFICE.lat, TARGET_OFFICE.lng
                    );
                    
                    console.log(`Distance to office: ${distance.toFixed(1)}m (accuracy: ¬±${accuracy.toFixed(0)}m)`);
                    console.log(`User location: ${userLat}, ${userLng}`);
                    console.log(`Target location: ${TARGET_OFFICE.lat}, ${TARGET_OFFICE.lng}`);
                    
                    // Allow some tolerance for GPS accuracy
                    const allowedDistance = TARGET_OFFICE.radius + Math.min(accuracy, 100);
                    
                    if (distance <= allowedDistance) {
                        showLocationVerified(distance, accuracy);
                        hasValidAccess = true;
                        checkExistingRegistration();
                    } else {
                        showAccessDenied(`You are ${distance.toFixed(0)}m from your office. You must be within ${TARGET_OFFICE.radius}m of your registered office address to participate in WorkStar.`);
                    }
                },
                function(error) {
                    let errorMessage = "Location verification failed. ";
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage += "Please allow location access and try again.";
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage += "Your location cannot be determined. Please try again or move to an area with better GPS signal.";
                            break;
                        case error.TIMEOUT:
                            errorMessage += "Location request timed out. Please try again.";
                            break;
                        default:
                            errorMessage += "Unknown location error. Please try again.";
                            break;
                    }
                    
                    showAccessDenied(errorMessage + " Registration requires location verification for security.");
                },
                {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 30000
                }
            );
        }
        
        function showAccessDenied(message) {
            document.getElementById('accessStatus').innerHTML = `
                <div class="status error">
                    üö´ <strong>Access Denied</strong><br>
                    ${message}
                </div>
                <div class="info-box">
                    <strong>To access this page:</strong><br>
                    1. Be physically present at your registered office location<br>
                    2. Scan the official WorkStar QR code provided to your business<br>
                    3. Allow location access when prompted<br>
                    4. Must be within 50 meters of your office address
                </div>
                <div class="business-info">
                    <strong>Need help?</strong><br>
                    Contact WorkStar support with your Business ID: <strong>${businessId || 'N/A'}</strong>
                </div>
            `;
        }
        
        function showLocationVerified(distance, accuracy) {
            document.getElementById('accessStatus').innerHTML = `
                <div class="business-info">
                    <strong>üè¢ ${currentBusiness}</strong><br>
                    <small>Authorized WorkStar Location</small>
                </div>
                <div class="status success">
                    ‚úÖ <strong>Location Verified!</strong><br>
                    You are ${distance.toFixed(0)}m from your office<br>
                    <small>GPS accuracy: ¬±${accuracy.toFixed(0)}m</small>
                </div>
            `;
        }
        
        function checkExistingRegistration() {
            // Check if user has already registered today
            const today = getTodayKey();
            const existingRegistration = localStorage.getItem(`registration_${businessId}_${today}`);
            
            if (existingRegistration) {
                const employee = JSON.parse(existingRegistration);
                showAlreadyRegistered(employee);
            } else {
                showRegistrationForm();
            }
        }
        
        function showAlreadyRegistered(employee) {
            document.getElementById('alreadyRegistered').style.display = 'block';
            document.getElementById('alreadyRegistered').innerHTML = `
                <div class="business-info">
                    <strong>üè¢ ${currentBusiness}</strong>
                </div>
                <div class="already-registered">
                    <h2>‚úÖ Already Registered!</h2>
                    <p><strong>Name:</strong> ${employee.name}</p>
                    <p><strong>Phone:</strong> ${employee.phone}</p>
                    <p><strong>Company:</strong> ${employee.business}</p>
                    <p><strong>Registered:</strong> ${employee.timestamp}</p>
                </div>
                
                <div class="prize-info">
                    <h3>üéØ WorkStar Daily Competition</h3>
                    <p><strong>Prize Draw:</strong> 10:00 AM daily</p>
                    <p>Watch for your name to appear on the WorkStar competition website!</p>
                    <p>If called, you'll have 3 minutes to phone in and answer a trivia question.</p>
                </div>
                
                <div class="countdown" id="countdown"></div>
            `;
            
            startCountdown();
        }
        
        function showRegistrationForm() {
            document.getElementById('registrationForm').style.display = 'block';
            document.getElementById('registrationForm').innerHTML = `
                <div class="business-info">
                    <strong>üè¢ ${currentBusiness}</strong><br>
                    <small>WorkStar Competition Registration</small>
                </div>
                
                <div class="form-section">
                    <div class="prize-info">
                        <h3>üèÜ WorkStar Daily Prize</h3>
                        <p><strong>Daily Draw:</strong> 10:00 AM</p>
                        <p><strong>Prize:</strong> $100 Gift Card</p>
                        <p>Register now for your chance to win!</p>
                    </div>
                    
                    <form id="employeeForm">
                        <div class="form-group">
                            <label for="employeeName">Full Name:</label>
                            <input type="text" id="employeeName" required placeholder="Enter your full name">
                        </div>
                        
                        <div class="form-group">
                            <label for="employeePhone">Phone Number:</label>
                            <input type="tel" id="employeePhone" required placeholder="Enter your phone number (required for prize calls)">
                        </div>
                        
                        <div class="form-group">
                            <label for="employeeEmail">Email (optional):</label>
                            <input type="email" id="employeeEmail" placeholder="Enter your email address">
                        </div>
                        
                        <button type="submit" class="register-btn">
                            üéØ Register for Today's Competition
                        </button>
                    </form>
                    
                    <div class="steps">
                        <h4>What happens next:</h4>
                        <div class="step">üìù Your registration is confirmed for ${currentBusiness}</div>
                        <div class="step">üé≤ At 10AM, one name is randomly selected from all participants</div>
                        <div class="step">üìû Selected person has 3 minutes to call the displayed number</div>
                        <div class="step">üß† Answer the trivia question correctly to win the prize!</div>
                    </div>
                </div>
            `;
            
            document.getElementById('employeeForm').addEventListener('submit', handleRegistration);
        }
        
        function handleRegistration(e) {
            e.preventDefault();
            
            const name = document.getElementById('employeeName').value.trim();
            const phone = document.getElementById('employeePhone').value.trim();
            const email = document.getElementById('employeeEmail').value.trim();
            
            if (!name || !phone) {
                alert('Please fill in all required fields (Name and Phone Number)');
                return;
            }
            
            // Validate phone number format
            const phoneRegex = /^[\d\s\+\-\(\)]{8,}$/;
            if (!phoneRegex.test(phone)) {
                alert('Please enter a valid phone number');
                return;
            }
            
            // Check if phone number already registered today for this business
            const today = getTodayKey();
            if (hasRegisteredToday(phone)) {
                alert('This phone number is already registered for today\'s competition');
                return;
            }
            
            const employee = {
                name: name,
                phone: phone,
                email: email,
                business: currentBusiness,
                businessId: businessId,
                timestamp: new Date().toLocaleString(),
                registrationDate: today,
                coordinates: TARGET_OFFICE
            };
            
            // Store registration with business-specific key
            localStorage.setItem(`registration_${businessId}_${today}`, JSON.stringify(employee));
            registerForToday(employee);
            
            // Show success
            document.getElementById('registrationForm').innerHTML = `
                <div class="business-info">
                    <strong>üè¢ ${currentBusiness}</strong>
                </div>
                
                <div class="status success">
                    üéâ <strong>Registration Successful!</strong><br>
                    Welcome to today's competition, ${name}!
                </div>
                
                <div class="prize-info">
                    <h3>üéØ You're in the WorkStar Competition!</h3>
                    <p><strong>Name:</strong> ${name}</p>
                    <p><strong>Phone:</strong> ${phone}</p>
                    <p><strong>Company:</strong> ${currentBusiness}</p>
                    <p><strong>Competition Time:</strong> 10:00 AM daily</p>
                </div>
                
                <div class="steps">
                    <h4>Important Reminders:</h4>
                    <div class="step">üì± Keep your phone nearby at 10AM</div>
                    <div class="step">‚è∞ If your name is called, you have 3 minutes to respond</div>
                    <div class="step">üìû Call the number displayed on the competition screen</div>
                    <div class="step">üß† Answer the trivia question correctly to win!</div>
                    <div class="step">üîÑ Register again tomorrow for another chance to win</div>
                </div>
                
                <div class="countdown" id="countdown"></div>
            `;
            
            startCountdown();
        }
        
        function startCountdown() {
            const countdownElement = document.getElementById('countdown');
            
            function updateCountdown() {
                const now = new Date();
                const tomorrow10AM = new Date();
                tomorrow10AM.setHours(10, 0, 0, 0);
                
                if (now.getHours() >= 10) {
                    tomorrow10AM.setDate(tomorrow10AM.getDate() + 1);
                }
                
                const diff = tomorrow10AM - now;
                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                
                countdownElement.innerHTML = `
                    ‚è∞ Next Competition:<br>
                    <span style="font-size: 1.5rem;">${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}</span>
                `;
            }
            
            updateCountdown();
            setInterval(updateCountdown, 1000);
        }
        
        // Initialize the page
        window.onload = function() {
            console.log('Registration page loaded, checking QR access...');
            
            if (!checkQRAccess()) {
                console.log('QR access check failed');
                return;
            }
            
            console.log('QR access verified, checking location...');
            verifyLocation();
        };
        
        // Prevent page caching and bookmarking
        window.addEventListener('beforeunload', function() {
            // Clear the URL to prevent direct access attempts
            if (hasValidAccess) {
                window.history.replaceState({}, '', window.location.pathname);
            }
        });
        
        // Prevent back button access
        window.addEventListener('popstate', function(event) {
            if (!hasValidAccess) {
                window.location.replace(window.location.pathname);
            }
        });
    </script>
</body>
</html>